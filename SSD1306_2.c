/*
 * SSD1306.c
 *
 * Created: 04.04.2018 09:30:29
 * Author: Gössl
 */


#include "I2C.h"
#include "SSD1306.h"



// 0  4  8 12
// 1  5  9 13
// 2  6 10 14
// 3  7 11 15

static const uint8_t abc[][(SSD1306_FONT_HEIGHT*SSD1306_FONT_WIDTH) / 8] =
{
	{0x9F, 0xF9},	//0
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},	//10
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},	//20
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},
	{0x9F, 0xF9},	//30
	{0x9F, 0xF9},
	{0x00, 0x00},	//SPACE
	{0xB0, 0x00},	//!
	{0x03, 0x03},	//"
	{0x7A, 0xFA},	//#
	{0xFA, 0x0D},	//$
	{0x49, 0x92},	//%
	{0x52, 0xEA},	//&
	{0x30, 0x00},	//'
	{0x60, 0x09},	//(
	{0x90, 0x06},	//)
	{0x25, 0x05},	//*
	{0xE4, 0x04},	//+
	{0xC0, 0x00},	//,
	{0x44, 0x04},	//-
	{0x80, 0x00},	//.
	{0xC0, 0x03},	///
	{0x96, 0x06},	//0
	{0xFa, 0x08},	//1
	{0xD9, 0x0A},	//2
	{0xB9, 0x05},	//3
	{0x47, 0x4F},	//4
	{0xBB, 0x05},	//5
	{0xBE, 0x05},	//6
	{0xD1, 0x03},	//7
	{0xD2, 0x4B},	//8
	{0xDA, 0x06},	//9
	{0x50, 0x00},	//:
	{0xD0, 0x00},	//;
	{0x40, 0x0A},	//<
	{0xAA, 0x0A},	//=
	{0xA0, 0x04},	//>
	{0x90, 0x03},	//?
	{0x9F, 0x7F},	//@
	{0x5E, 0x0E},	//A
	{0xBF, 0x06},	//B
	{0x96, 0x09},	//C
	{0x9F, 0x06},	//D
	{0xBF, 0x09},	//E
	{0x5F, 0x01},	//F
	{0x96, 0x4D},	//G
	{0x2F, 0x0F},	//H
	{0xF9, 0x09},	//I
	{0x79, 0x01},	//J
	{0x2F, 0x0D},	//K
	{0x8F, 0x08},	//L
	{0x2F, 0xF1},	//M
	{0x2F, 0xF4},	//N
	{0x96, 0x69},	//O
	{0x5F, 0x02},	//P
	{0x96, 0xED},	//Q
	{0x5F, 0x0A},	//R
	{0xB0, 0x0D},	//S
	{0xF1, 0x01},	//T
	{0x87, 0x0F},	//U
	{0x87, 0x07},	//V
	{0x4F, 0xF4},	//W
	{0x69, 0x09},	//X
	{0xC3, 0x03},	//Y
	{0xD0, 0x0B},	//Z
	{0xF0, 0x09},	//[
	{0x30, 0x0C},	/*\*/
	{0x90, 0x0F},	//]
	{0x12, 0x02},	//^
	{0x88, 0x88},	//_
	{0x10, 0x02},	//`
	{0xA4, 0x0E},	//a
	{0xAF, 0x04},	//b
	{0xC0, 0x0A},	//c
	{0xA4, 0x0F},	//d
	{0xE4, 0x0A},	//e
	{0xE4, 0x05},	//f
	{0xD2, 0x0F},	//g
	{0x2F, 0x0C},	//h
	{0xD0, 0x00},	//i
	{0xD8, 0x00},	//j
	{0x4F, 0x0A},	//k
	{0x8F, 0x00},	//l
	{0x2E, 0xCE},	//m
	{0x2E, 0x0C},	//n
	{0xAC, 0x06},	//o
	{0xAE, 0x06},	//p
	{0xA6, 0x0E},	//q
	{0xE0, 0x02},	//r
	{0xE0, 0x0A},	//s
	{0xF2, 0x02},	//t
	{0x86, 0x0E},	//u
	{0x86, 0x06},	//v
	{0xC6, 0x6C},	//w
	{0x4A, 0x0A},	//x
	{0x4A, 0x02},	//y
	{0xA0, 0x0E},	//z
	{0x62, 0x09},	//{
	{0x69, 0x02},	//}
	{0xF0, 0x00},	//|
	{0x24, 0x24},	//~
	{0x9F, 0xF9},	//DEL
};



void SSD1306_init(void)
{
	I2C_init();
	
	
	//Display: Off
	SSD1306_sendCommand(SSD1306_DISPLAYOFF);
	
	//Enable charge pump
	SSD1306_sendCommand(SSD1306_CHARGEPUMP);
	SSD1306_sendCommand(0x14);
	
	//Memory mode: Horizontal
	SSD1306_sendCommand(SSD1306_MEMORYMODE);
	SSD1306_sendCommand(0x00);
	
	//Contrast: Max
	SSD1306_sendCommand(SSD1306_SETCONTRAST);
	SSD1306_sendCommand(0xFF);
	
	//Display: On
	SSD1306_sendCommand(SSD1306_DISPLAYON);
}

void SSD1306_sendCommand(uint8_t command)
{
	I2C_start();
	I2C_write(SSD1306_DEVICE_W);
	//Co: 0=data only, D/C#: 0=data, 1=command
	I2C_write(0x00);
	I2C_write(command);
	I2C_stop();
}

void SSD1306_sendBuffer(uint8_t* buffer)
{
	uint8_t packet;
	uint8_t packet_byte;
	
	SSD1306_sendCommand(SSD1306_COLUMNADDR);
	SSD1306_sendCommand(0x00);
	SSD1306_sendCommand(128-1);
	
	SSD1306_sendCommand(SSD1306_PAGEADDR);
	SSD1306_sendCommand(0x00);
	SSD1306_sendCommand(0x07);
	
	// We have to send the buffer as 16 bytes packets
	// Our buffer is 1024 bytes long, 1024/16 = 64
	// We have to send 64 packets
	for(packet=0; packet<SSD1306_BUFFER_LENGTH/16; packet++)
	{
		I2C_start();
		I2C_write(SSD1306_DEVICE_W);
		I2C_write(0x40);
		for(packet_byte = 0; packet_byte<16; ++packet_byte)
			I2C_write(buffer[packet*16 + packet_byte]);
		I2C_stop();
	}
}


void SSD1306_bufferClear(uint8_t* buffer)
{
	int i;
	
	for(i=0; i<SSD1306_BUFFER_LENGTH; i++)
		buffer[i] = 0x00;
}

void SSD1306_bufferDrawPixel(int x, int y, uint8_t* buffer)
{
	int byte = x + y/8*SSD1306_WIDTH;
	int bit = y%8;
	
	buffer[byte] |= (1 << bit);
}

void SSD1306_bufferClearPixel(int x, int y, uint8_t* buffer)
{
	int byte = x + y/8*SSD1306_WIDTH;
	int bit = y%8;
	
	buffer[byte] &= ~(1 << bit);
}

void SSD1306_bufferDrawCharacter(int x, int y, char character, uint8_t* buffer)
{
	int i;
	
	for(i=0; i<SSD1306_FONT_HEIGHT*SSD1306_FONT_WIDTH; i++)
	{
		//If there is a pixel
		if(abc[(int)character][i/8] & (1 << i%8))
			SSD1306_bufferDrawPixel(x + i/SSD1306_FONT_HEIGHT, y + i%SSD1306_FONT_HEIGHT, buffer);
		else
			SSD1306_bufferClearPixel(x + i/SSD1306_FONT_HEIGHT, y + i%SSD1306_FONT_HEIGHT, buffer);
	}
}

void SSD1306_bufferPrintString(char* string, uint8_t* buffer)
{
	int i;
	int line=0, column=0;
	
	
	for(i=0; i<SSD1306_FONT_LINES*SSD1306_FONT_LINE_LENGTH && string[i]!='\0' && line<SSD1306_FONT_LINES; i++)
	{
		if(string[i] == '\n')
		{
			line++;
			column = 0;
		}
		else
		{
			SSD1306_bufferDrawCharacter(column*(SSD1306_FONT_WIDTH+1) + 1, line*(SSD1306_FONT_HEIGHT+1) + 1, string[i], buffer);
			column++;
			
			if(column >= SSD1306_FONT_LINE_LENGTH)
			{
				line++;
				column = 0;
			}
		}
	}
}
